<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://justingps.github.io/dpr/favicon.png">
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        .logo {
            max-width: 100px;
            margin-right: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            background-color: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        .btn {
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            width: 180px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .btn-add {
            background-color: #4CAF50;
        }
        .btn-add:hover {
            background-color: #45a049;
        }
        .btn-remove {
            background-color: #f44336;
        }
        .btn-remove:hover {
            background-color: #d32f2f;
        }
        .resource-entry {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .resource-entry input {
            flex: 1;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            width: 350px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .modal-content label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        .modal-content input,
        .modal-content select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        .modal-buttons .btn-confirm {
            background-color: #4CAF50;
            color: white;
        }
        .modal-buttons .btn-confirm:hover {
            background-color: #45a049;
        }
        .modal-buttons .btn-cancel {
            background-color: #f44336;
            color: white;
        }
        .modal-buttons .btn-cancel:hover {
            background-color: #d32f2f;
        }
        #submitButton {
            width: 100%;
            padding: 12px;
            font-size: 16px;
        }
        .section-title {
            font-size: 18px;
            margin: 25px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #4CAF50;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="logo.png" alt="Company Logo" class="logo">
            <div>
                <h2>DAILY SITE REPORT</h2>
                <p style="color: #666; margin-top: 5px;">Complete your daily work report</p>
            </div>
        </div>

        <form id="reportForm">
            <div class="form-group">
                <label for="date">Date:</label>
                <input type="date" id="date" name="date" required>
            </div>

            <div class="form-group">
                <label>Permit Details:</label>
                <div class="resource-entry">
                    <input type="text" id="permitNumber" placeholder="Permit Number" required>
                    <input type="time" id="validationTime" placeholder="Validation Time" required>
                    <input type="time" id="suspensionTime" placeholder="Suspension Time" required>
                </div>
            </div>

            <div class="form-group">
                <label for="foremanID">Foreman ID:</label>
                <input type="text" id="foremanID" name="foremanID" placeholder="Enter Foreman ID" required>
            </div>

            <div class="form-group">
                <label for="wiReference">Work Instruction No:</label>
                <input type="text" id="wiReference" name="wiReference" placeholder="Enter WI Number" required>
            </div>

            <div class="form-group">
                <label for="discipline">Discipline:</label>
                <select id="discipline" name="discipline" required>
                    <option value="" disabled selected>Select Discipline</option>
                    <option value="Civil Works">Civil Works</option>
                    <option value="Piping, Structural & Mechanical">Piping, Structural & Mechanical</option>
                    <option value="Electrical">Electrical</option>
                    <option value="Instrumentation">Instrumentation</option>
                    <option value="Commissioning">Commissioning</option>
                    <option value="Scaffolding">Scaffolding</option>
                    <option value="Vendor Support">Vendor Support</option>
                    <option value="Demolition">Demolition</option>
                    <option value="Shutdown">Shutdown</option>
                    <option value="Other">Other</option>
                </select>
            </div>

            <div class="form-group">
                <label for="description">Description of Work:</label>
                <textarea id="description" name="description" placeholder="Describe the work performed today" required></textarea>
            </div>

            <div class="section-title">Resource Details</div>
            <div class="form-group">
                <table id="personnelTable">
                    <thead>
                        <tr>
                            <th>Resource ID</th>
                            <th>Time-In</th>
                            <th>Time-Out</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Resources will be added here dynamically -->
                    </tbody>
                </table>
                <div class="button-container">
                    <button type="button" class="btn btn-add" onclick="openResourceModal()">Add Resource</button>
                    <button type="button" class="btn btn-remove" onclick="removeLastPersonnel()">Remove Last</button>
                </div>
            </div>

            <div class="section-title">Progress Details</div>
            <div class="form-group">
                <table id="progressTable">
                    <thead>
                        <tr>
                            <th>Discipline</th>
                            <th>Activity</th>
                            <th>Quantity</th>
                            <th>Unit</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Progress entries will be added here dynamically -->
                    </tbody>
                </table>
                <div class="button-container">
                    <button type="button" class="btn btn-add" onclick="openProgressModal()">Add Progress</button>
                    <button type="button" class="btn btn-remove" onclick="removeLastProgress()">Remove Last</button>
                </div>
            </div>

            <button type="submit" class="btn btn-add" id="submitButton">Submit Daily Report</button>
        </form>
    </div>

    <!-- Resource Entry Modal -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0; margin-bottom: 20px;">Add Resource</h3>
            
            <label for="modalResourceID">Resource ID:</label>
            <input type="text" id="modalResourceID" placeholder="Enter employee or equipment ID" required>

            <label for="modalTimeIn">Time-in:</label>
            <input type="time" id="modalTimeIn" required>

            <label for="modalTimeOut">Time-out:</label>
            <input type="time" id="modalTimeOut" required>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeResourceModal()">Cancel</button>
                <button class="btn-confirm" onclick="addResource()">Add Resource</button>
            </div>
        </div>
    </div>

    <!-- Progress Entry Modal -->
    <div id="progressModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top: 0; margin-bottom: 20px;">Add Progress Entry</h3>
            
            <label for="modalProgressDiscipline">Discipline:</label>
            <select id="modalProgressDiscipline" onchange="updateActivityDropdown()" required>
                <option value="" disabled selected>Select Discipline</option>
                <option value="CIVIL">CIVIL</option>
                <option value="PIPING STRUCTURAL & MECHANICAL">PIPING STRUCTURAL & MECHANICAL</option>
                <option value="ELECTRICAL">ELECTRICAL</option>
                <option value="INSTRUMENTATION">INSTRUMENTATION</option>
                <option value="COMMISSIONING">COMMISSIONING</option>
                <option value="SCAFFOLDING">SCAFFOLDING</option>
                <option value="DEMOLITION">DEMOLITION</option>
                <option value="SHUTDOWN">SHUTDOWN</option>
            </select>

            <label for="modalActivity">Activity:</label>
            <select id="modalActivity" onchange="toggleCustomActivityInput()" required>
                <option value="">Select Activity</option>
                <!-- Activities will be populated dynamically based on discipline -->
                <option value="Other">Other</option>
            </select>
            <input type="text" id="customActivity" placeholder="Enter Custom Activity" style="display: none; margin-top: 5px;">

            <label for="modalQuantity">Quantity:</label>
            <input type="number" id="modalQuantity" placeholder="Enter Quantity" required>

            <label for="modalUnit">Unit:</label>
            <select id="modalUnit" required>
                <option value="" disabled selected>Select Unit</option>
                <option value="M">M</option>
                <option value="M2">M2</option>
                <option value="M3">M3</option>
                <option value="NO">NO</option>
                <option value="T">T</option>
                <option value="KG">KG</option>
                <option value="IN. DIA">IN. DIA</option>
            </select>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeProgressModal()">Cancel</button>
                <button class="btn-confirm" onclick="addProgressEntry()">Add Entry</button>
            </div>
        </div>
    </div>

    <script>
        // Store resource and progress entries
        let personnelEntries = [];
        let progressEntries = [];
        let defaultTimeIn = null;
        let defaultTimeOut = null;

        // Activity lists based on discipline
        const activities = {
            "CIVIL": [
                "SURVEY & MARKING",
                "TRIAL PIT EXCAVATION",
                "EXCAVATION (MANUAL)",
                "EXCAVATION (MECHANICAL)",
                "PROTECTIVE COATING",
                "FOUNDATION INSTALLATION",
                "BACKFILLING",
                "COMPACTION",
                "REINFORCEMENT",
                "FORMWORK",
                "CONCRETING",
                "CORE DRILLING"
            ],
            "PIPING STRUCTURAL & MECHANICAL": [
                "PIPING ERECTION",
                "FLOWLINE ERECTION",
                "FLOWLINE WELDING",
                "NDT",
                "HYDROTESTING",
                "REINSTATEMENT OF SPOOLS",
                "TORQUING",
                "SUPPORT STRUCTURE INSTALLATION",
                "SUPPORT STRUCTURE FABRICATION",
                "PAINTING",
                "PIPING FABRICATION",
                "EXTERNAL PAINTING",
                "SPOOLS INSTALLATION",
                "SHOP WELD",
                "FIELD WELDING",
                "VALVES INSTALLATION",
                "REINSTATEMENT"
            ],
            "ELECTRICAL": [
                "HV CABLE LAYING | 3C X 70 SQMM",
                "HV CABLE LAYING | 3C X 50 SQMM",
                "LV CABLE LAYING | 3C X 240 SQMM,",
                "LV CABLE LAYING | 3C X185 SQMM",
                "LV CABLE LAYING | 3C X 120 SQMM",
                "LV CABLE LAYING | 3C X 50 SQMM",
                "LV CABLE LAYING | 3C X 35 SQMM,",
                "LV CABLE LAYING | 3C X 25 SQMM",
                "LV CABLE LAYING | 3C X 16 SQM",
                "LV CABLE LAYING | 3C X 4 SQMM",
                "LV CABLE LAYING | 3C X 2.5 SQMM",
                "LV CABLE LAYING | 4C X 150 SQMM",
                "LV CABLE LAYING | 4C X 70 SQMM",
                "LV CABLE LAYING | 4C X 25 SQMM",
                "LV CABLE LAYING | 4C X 16 SQMM",
                "LV CABLE LAYING | 4C X 10 SQMM",
                "LV CABLE LAYING | 4C X 6 SQMM",
                "LV CABLE LAYING | 7C X 2.5 SQMM",
                "LV CABLE LAYING | 12C X2.5 SQMM",
                "LV CABLE LAYING | 19C X2.5 SQMM",
                "LV CABLE LAYING | 5C X2.5 SQMM",
                "LV CABLE LAYING | 2C X4 SQMM",
                "LV CABLE LAYING | 2C X2.5 SQMM",
                "LV CABLE LAYING | 2 PAIR X 2.5 SQ.MM",
                "LV CABLE LAYING | 20 PAIR X 1.5 SQ.MM"
            ],
            "INSTRUMENTATION": [
                "CABEL LAYING |1 PAIR X1.5 SQMM",
                "CABEL LAYING |2 PAIR X1.5 SQMM",
                "CABEL LAYING |5 PAIR X.75 SQMM",
                "CABEL LAYING |5 PAIR X1.5 SQMM",
                "CABEL LAYING |10 PAIR X1 SQMM",
                "CABEL LAYING |10 PAIR X1.5 SQMM",
                "CABEL LAYING |20 PAIR X1.5 SQMM",
                "CABEL LAYING |2 CORE X 2.5 SQ MM",
                "CABEL LAYING |21COREX2.5 SQ.MM",
                "CABEL LAYING |FOC 4 CORE",
                "CABEL LAYING |FOC 12 CORE",
                "CABEL LAYING |FOC 24 CORE",
                "CABEL LAYING |CAT-6/6E",
                "CABEL LAYING |MODBUS RS-485"
            ],
            "COMMISSIONING": [
                "LOOP TESTING",
                "FUNCTION TEST",
                "CALIBRATION"
            ],
            "SCAFFOLDING": [
                "ERECTION",
                "DISMANTLING"
            ],
            "DEMOLITION": [
                "FOUNDATION",
                "CABLES",
                "INSTRUMENTS"
            ],
            "SHUTDOWN": [
                "TIE-INS"
            ]
        };

        // Set today's date as default
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById("date").value = today;
        });

        // Resource Modal Functions
        function openResourceModal() {
            if (defaultTimeIn && defaultTimeOut) {
                document.getElementById("modalTimeIn").value = defaultTimeIn;
                document.getElementById("modalTimeOut").value = defaultTimeOut;
            }
            document.getElementById("resourceModal").style.display = "flex";
            document.getElementById("modalResourceID").focus();
        }

        function closeResourceModal() {
            document.getElementById("resourceModal").style.display = "none";
            document.getElementById("modalResourceID").value = "";
            document.getElementById("modalTimeIn").value = "";
            document.getElementById("modalTimeOut").value = "";
        }

        function addResource() {
            const resourceID = document.getElementById("modalResourceID").value.trim();
            const timeIn = document.getElementById("modalTimeIn").value;
            const timeOut = document.getElementById("modalTimeOut").value;

            if (!resourceID) {
                alert("Please enter a Resource ID");
                return;
            }
            if (!timeIn || !timeOut) {
                alert("Please enter both Time-in and Time-out");
                return;
            }

            if (personnelEntries.length === 0) {
                defaultTimeIn = timeIn;
                defaultTimeOut = timeOut;
            }

            personnelEntries.push({
                id: resourceID,
                timeIn: timeIn,
                timeOut: timeOut
            });

            updatePersonnelTable();
            closeResourceModal();
        }

        function removeLastPersonnel() {
            if (personnelEntries.length > 0) {
                personnelEntries.pop();
                updatePersonnelTable();
                
                if (personnelEntries.length === 0) {
                    defaultTimeIn = null;
                    defaultTimeOut = null;
                }
            } else {
                alert("No entries to remove.");
            }
        }

        function updatePersonnelTable() {
            const tbody = document.querySelector("#personnelTable tbody");
            tbody.innerHTML = personnelEntries.map(entry => `
                <tr>
                    <td>${entry.id}</td>
                    <td>${entry.timeIn}</td>
                    <td>${entry.timeOut}</td>
                </tr>
            `).join("");
        }

        // Progress Modal Functions
        function openProgressModal() {
            document.getElementById("progressModal").style.display = "flex";
            document.getElementById("modalProgressDiscipline").focus();
        }

        function closeProgressModal() {
            document.getElementById("progressModal").style.display = "none";
            document.getElementById("modalProgressDiscipline").value = "";
            document.getElementById("modalActivity").innerHTML = '<option value="">Select Activity</option>';
            document.getElementById("modalQuantity").value = "";
            document.getElementById("modalUnit").value = "";
            document.getElementById("customActivity").value = "";
            document.getElementById("customActivity").style.display = "none";
        }

        function updateActivityDropdown() {
            const discipline = document.getElementById("modalProgressDiscipline").value;
            const activityDropdown = document.getElementById("modalActivity");
            activityDropdown.innerHTML = '<option value="">Select Activity</option>';

            if (discipline && activities[discipline]) {
                activities[discipline].forEach(activity => {
                    const option = document.createElement("option");
                    option.value = activity;
                    option.textContent = activity;
                    activityDropdown.appendChild(option);
                });
                const otherOption = document.createElement("option");
                otherOption.value = "Other";
                otherOption.textContent = "Other";
                activityDropdown.appendChild(otherOption);
            }
        }

        function toggleCustomActivityInput() {
            const activityDropdown = document.getElementById("modalActivity");
            const customActivityInput = document.getElementById("customActivity");
            if (activityDropdown.value === "Other") {
                customActivityInput.style.display = "block";
                customActivityInput.required = true;
            } else {
                customActivityInput.style.display = "none";
                customActivityInput.required = false;
            }
        }

        function addProgressEntry() {
            const discipline = document.getElementById("modalProgressDiscipline").value;
            let activity = document.getElementById("modalActivity").value;
            const quantity = document.getElementById("modalQuantity").value;
            const unit = document.getElementById("modalUnit").value;

            if (activity === "Other") {
                activity = document.getElementById("customActivity").value;
            }

            if (!discipline || !activity || !quantity || !unit) {
                alert("Please fill in all fields.");
                return;
            }

            progressEntries.push({
                discipline: discipline,
                activity: activity,
                quantity: quantity,
                unit: unit
            });

            updateProgressTable();
            closeProgressModal();
        }

        function removeLastProgress() {
            if (progressEntries.length > 0) {
                progressEntries.pop();
                updateProgressTable();
            } else {
                alert("No entries to remove.");
            }
        }

        function updateProgressTable() {
            const tbody = document.querySelector("#progressTable tbody");
            tbody.innerHTML = progressEntries.map(entry => `
                <tr>
                    <td>${entry.discipline}</td>
                    <td>${entry.activity}</td>
                    <td>${entry.quantity}</td>
                    <td>${entry.unit}</td>
                </tr>
            `).join("");
        }

        // Form submission handler
        document.getElementById("reportForm").onsubmit = function(e) {
            e.preventDefault();

            // Validate at least one resource entry
            if (personnelEntries.length === 0) {
                alert("Please add at least one resource entry.");
                return;
            }

            const submitButton = document.getElementById("submitButton");
            submitButton.disabled = true;
            submitButton.innerText = "Submitting...";

            // Create timestamp for submission
            const postingDateTime = new Date().toISOString().slice(0, 19).replace("T", " ");

            // Prepare form data (now includes progress entries)
            const formData = {
                date: document.getElementById("date").value,
                foremanID: document.getElementById("foremanID").value,
                wiReference: document.getElementById("wiReference").value,
                discipline: document.getElementById("discipline").value,
                description: document.getElementById("description").value,
                personnel: JSON.stringify(personnelEntries),
                progressEntries: JSON.stringify(progressEntries),
                permitNumber: document.getElementById("permitNumber").value,
                validationTime: document.getElementById("validationTime").value,
                suspensionTime: document.getElementById("suspensionTime").value,
                postingDateTime: postingDateTime,
                deviceDetails: JSON.stringify({
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    screenResolution: `${window.screen.width}x${window.screen.height}`
                })
            };

            // Convert to URL parameters
            const queryParams = new URLSearchParams();
            for (const [key, value] of Object.entries(formData)) {
                queryParams.append(key, value);
            }

            // Submit to Google Apps Script endpoint
            fetch(`https://script.google.com/macros/s/AKfycbzR8iVBfg4fqXv9v1pWhGQ56DZ844qsVvjM-D4VMN19BeCT-ISid02kRqJuccVRnstI2w/exec?${queryParams.toString()}`, {
                method: "GET",
            })
            .then(response => response.text())
            .then(data => {
                alert("Report submitted successfully!");
                // Reset form
                personnelEntries = [];
                progressEntries = [];
                defaultTimeIn = null;
                defaultTimeOut = null;
                updatePersonnelTable();
                updateProgressTable();
                document.getElementById("reportForm").reset();
                // Set today's date again after reset
                const today = new Date().toISOString().split('T')[0];
                document.getElementById("date").value = today;
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Submission failed: " + error.message);
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.innerText = "Submit Daily Report";
            });
        };
    </script>
</body>
</html>
